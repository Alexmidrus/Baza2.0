{% extends "base.html" %}
{% block title %}Админ-панель — Домики и беседки{% endblock %}

{% block body %}
<header class="sticky top-0 z-40 bg-white/85 backdrop-blur border-b border-gray-200">
  <div class="mx-auto max-w-6xl px-4">
    <div class="flex h-16 items-center justify-between gap-3">
      <a href="{{ url_for('index') }}" class="flex items-center gap-2">
        <div class="h-9 w-9 rounded-xl bg-brand-50 border border-gray-200 grid place-items-center">
          <span class="font-display font-extrabold text-brand-600">Ж</span>
        </div>
        <div class="leading-tight">
          <div class="font-display font-extrabold">Жемчужина</div>
          <div class="text-xs text-slate-600 -mt-0.5">админ-панель</div>
        </div>
      </a>

      <form method="post" action="{{ url_for('admin_logout') }}">
        <button class="h-10 rounded-xl border border-gray-200 bg-white px-4 text-sm font-semibold hover:bg-slate-50">
          Выйти
        </button>
      </form>
    </div>
  </div>
</header>

<main class="mx-auto max-w-6xl px-4 py-8">
  <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
    <div>
      <h1 class="font-display text-3xl font-extrabold">Домики и беседки</h1>
      <p class="text-slate-600 mt-1">CRUD через Flask API (данные в data/items.json).</p>
    </div>

    <div class="flex flex-wrap gap-2">
      <button class="rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50" onclick="openModal('houses')">
        + Добавить домик
      </button>
      <button class="rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50" onclick="openModal('gazebos')">
        + Добавить беседку
      </button>
    </div>
  </div>

  <div class="mt-6 flex flex-wrap gap-2">
    <button id="tab-houses" class="tabBtn rounded-xl border border-brand-500 bg-brand-50 px-4 py-2 text-sm font-semibold" onclick="setTab('houses')">
      Домики
    </button>
    <button id="tab-gazebos" class="tabBtn rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50" onclick="setTab('gazebos')">
      Беседки
    </button>

    <div class="flex-1"></div>

    <div class="w-full sm:w-auto flex gap-2">
      <input id="search" type="text" placeholder="Поиск по названию..."
        class="flex-1 sm:w-72 h-10 rounded-xl border border-gray-200 px-3 outline-none focus:ring-4 focus:ring-brand-50 focus:border-brand-500"
        oninput="render()">
      <select id="sort" class="h-10 rounded-xl border border-gray-200 px-3 text-sm font-semibold"
        onchange="render()">
        <option value="name">Сортировка: по названию</option>
        <option value="price">Сортировка: по цене</option>
      </select>
    </div>
  </div>

  <section class="mt-5 rounded-3xl border border-gray-200 bg-white shadow-soft overflow-hidden">
    <div class="p-4 sm:p-5 border-b border-gray-200 flex items-center justify-between gap-3">
      <div>
        <div id="listTitle" class="font-display font-extrabold text-lg">Список: Домики</div>
        <div id="listMeta" class="text-sm text-slate-600 mt-0.5">Записей: 0</div>
      </div>
      <div id="apiMeta" class="text-xs text-slate-500 hidden sm:block"></div>
    </div>

    <div class="hidden md:block overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-50 text-slate-700">
          <tr class="[&>th]:text-left [&>th]:px-5 [&>th]:py-3 [&>th]:font-semibold">
            <th>Название</th>
            <th class="w-28">Цена</th>
            <th class="w-32">Статус</th>
            <th class="w-56">Параметры</th>
            <th class="w-40 text-right">Действия</th>
          </tr>
        </thead>
        <tbody id="tbody" class="[&>tr]:border-t [&>tr]:border-gray-200"></tbody>
      </table>
    </div>

    <div id="cards" class="md:hidden p-4 grid gap-3"></div>
  </section>
</main>

<!-- Modal -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-slate-900/40 p-4">
  <div class="w-full max-w-xl rounded-3xl border border-gray-200 bg-white shadow-soft overflow-hidden">
    <div class="p-5 border-b border-gray-200 flex items-start justify-between gap-4">
      <div>
        <div id="modalTitle" class="font-display text-xl font-extrabold">Новая запись</div>
        <div id="modalSub" class="text-sm text-slate-600 mt-1">Заполните поля и сохраните.</div>
      </div>
      <button class="h-10 w-10 rounded-xl border border-gray-200 grid place-items-center hover:bg-slate-50" onclick="closeModal()" aria-label="Закрыть">
        <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 6l12 12M18 6L6 18"/>
        </svg>
      </button>
    </div>

    <form class="p-5 grid gap-3" onsubmit="event.preventDefault(); saveItem();">
      <input type="hidden" id="editId" />
      <input type="hidden" id="editType" />

      <div class="grid sm:grid-cols-2 gap-3">
        <label class="grid gap-1">
          <span class="text-xs font-semibold text-slate-800">Название</span>
          <input id="fName" required type="text"
            class="h-11 rounded-xl border border-gray-200 px-3 outline-none focus:ring-4 focus:ring-brand-50 focus:border-brand-500">
        </label>

        <label class="grid gap-1">
          <span class="text-xs font-semibold text-slate-800">Цена (₽)</span>
          <input id="fPrice" required type="number" min="0" step="100"
            class="h-11 rounded-xl border border-gray-200 px-3 outline-none focus:ring-4 focus:ring-brand-50 focus:border-brand-500">
        </label>
      </div>

      <div class="grid sm:grid-cols-2 gap-3">
        <label class="grid gap-1">
          <span class="text-xs font-semibold text-slate-800">Статус</span>
          <select id="fStatus" class="h-11 rounded-xl border border-gray-200 px-3 outline-none focus:ring-4 focus:ring-brand-50 focus:border-brand-500">
            <option value="active">Активно (на сайте)</option>
            <option value="hidden">Скрыто</option>
          </select>
        </label>

        <div>
          <label class="grid gap-1">
            <span class="text-xs font-semibold text-slate-800">Изображение</span>
            <input id="fImageFile" type="file" accept="image/png,image/jpeg,image/webp"
              class="h-11 rounded-xl border border-gray-200 bg-white px-3 py-2 text-sm outline-none">
            <span class="text-xs text-slate-500">PNG/JPG/WEBP. Файл будет сохранён под ID записи.</span>
          </label>

          <div class="mt-2 flex items-center gap-3">
            <div id="imgPreview" class="h-16 w-24 rounded-xl border border-gray-200 overflow-hidden bg-slate-50 grid place-items-center text-xs text-slate-500">
              preview
            </div>
            <div class="text-sm text-slate-600">
              <div class="font-semibold">Текущее изображение</div>
              <div id="imgPath" class="text-xs text-slate-500 break-all">—</div>
            </div>
          </div>
        </div>
      </div>

      <!-- House fields -->
      <div id="houseFields" class="rounded-2xl border border-gray-200 p-4">
        <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Параметры домика</div>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
          <label class="grid gap-1 sm:col-span-1">
            <span class="text-xs font-semibold text-slate-800">Спальных мест</span>
            <input id="fBeds" type="number" min="1" step="1" value="4"
              class="h-11 rounded-xl border border-gray-200 px-3 outline-none focus:ring-4 focus:ring-brand-50 focus:border-brand-500">
          </label>
          <label class="inline-flex items-center gap-2 h-11 rounded-xl border border-gray-200 px-3 bg-white self-end">
            <input id="fWC" type="checkbox" class="h-4 w-4 rounded border-gray-300">
            <span class="text-sm font-semibold text-slate-800">Туалет</span>
          </label>
          <label class="inline-flex items-center gap-2 h-11 rounded-xl border border-gray-200 px-3 bg-white self-end">
            <input id="fKitchen" type="checkbox" class="h-4 w-4 rounded border-gray-300">
            <span class="text-sm font-semibold text-slate-800">Кухня</span>
          </label>
        </div>
      </div>

      <!-- Gazebo fields -->
      <div id="gazeboFields" class="rounded-2xl border border-gray-200 p-4 hidden">
        <div class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Параметры беседки</div>
        <div class="mt-3 grid sm:grid-cols-2 gap-3">
          <label class="grid gap-1">
            <span class="text-xs font-semibold text-slate-800">Категория</span>
            <select id="fGazType" class="h-11 rounded-xl border border-gray-200 px-3 outline-none focus:ring-4 focus:ring-brand-50 focus:border-brand-500">
              <option value="small">Малая</option>
              <option value="common">Общая</option>
              <option value="dome">Купольная</option>
              <option value="banquet">Банкетная</option>
            </select>
          </label>
          <label class="grid gap-1">
            <span class="text-xs font-semibold text-slate-800">Вместимость (гостей)</span>
            <input id="fCapacity" type="number" min="1" step="1" value="10"
              class="h-11 rounded-xl border border-gray-200 px-3 outline-none focus:ring-4 focus:ring-brand-50 focus:border-brand-500">
          </label>
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-2 pt-1">
        <button class="h-12 rounded-xl bg-brand-500 text-white font-semibold hover:bg-brand-600">
          Сохранить
        </button>
        <button type="button" class="h-12 rounded-xl border border-gray-200 font-semibold hover:bg-slate-50" onclick="closeModal()">
          Отмена
        </button>
      </div>

      <div id="formMsg" class="text-sm text-slate-600"></div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let activeTab = 'houses';
  let items = [];

  function statusBadge(status) {
    if (status === 'active') {
      return `<span class="inline-flex items-center gap-2 text-xs font-semibold text-green-700 bg-green-50 border border-green-200 px-2 py-1 rounded-full"><span class="h-2 w-2 bg-green-500 rounded-full"></span>Активно</span>`;
    }
    return `<span class="inline-flex items-center gap-2 text-xs font-semibold text-slate-700 bg-slate-50 border border-gray-200 px-2 py-1 rounded-full"><span class="h-2 w-2 bg-slate-400 rounded-full"></span>Скрыто</span>`;
  }

  function houseParams(h) {
    return `${h.beds} мест • WC: ${h.wc ? 'да' : 'нет'} • кухня: ${h.kitchen ? 'да' : 'нет'}`;
  }
  function gazeboParams(g) {
    const map = { small:'малая', common:'общая', dome:'купольная', banquet:'банкетная' };
    return `${map[g.gazType] || g.gazType} • до ${g.capacity} гостей`;
  }

  function formatRub(n) {
    return (Number(n) || 0).toLocaleString('ru-RU') + ' ₽';
  }
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function setTab(tab) {
    activeTab = tab;
    document.getElementById('tab-houses').className = tab === 'houses'
      ? 'tabBtn rounded-xl border border-brand-500 bg-brand-50 px-4 py-2 text-sm font-semibold'
      : 'tabBtn rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50';

    document.getElementById('tab-gazebos').className = tab === 'gazebos'
      ? 'tabBtn rounded-xl border border-brand-500 bg-brand-50 px-4 py-2 text-sm font-semibold'
      : 'tabBtn rounded-xl border border-gray-200 bg-white px-4 py-2 text-sm font-semibold hover:bg-slate-50';

    document.getElementById('listTitle').textContent = 'Список: ' + (tab === 'houses' ? 'Домики' : 'Беседки');
    fetchItems();
  }

  async function fetchItems() {
    const res = await fetch(`/api/admin/items?type=${activeTab}`, { credentials: 'same-origin' });
    if (!res.ok) {
      document.getElementById('apiMeta').textContent = 'Ошибка загрузки данных';
      return;
    }
    const data = await res.json();
    items = data.items || [];
    document.getElementById('apiMeta').textContent = `Источник: data/items.json`;
    render();
  }

  function sortItems(list) {
    const sort = document.getElementById('sort').value;
    if (sort === 'price') return list.slice().sort((a,b) => (a.price||0) - (b.price||0));
    return list.slice().sort((a,b) => String(a.name||'').localeCompare(String(b.name||''), 'ru'));
  }

  function filterItems(list) {
    const q = (document.getElementById('search').value || '').trim().toLowerCase();
    if (!q) return list;
    return list.filter(x => String(x.name||'').toLowerCase().includes(q));
  }

  function render() {
    const tbody = document.getElementById('tbody');
    const cards = document.getElementById('cards');
    tbody.innerHTML = '';
    cards.innerHTML = '';

    let list = filterItems(items);
    list = sortItems(list);

    document.getElementById('listMeta').textContent = `Записей: ${list.length}`;

    list.forEach(item => {
      const params = activeTab === 'houses' ? houseParams(item) : gazeboParams(item);

      const thumb = (item.image && typeof item.image === 'string' && item.image.startsWith('/static/uploads/'))
        ? `<img src="${item.image}" class="h-10 w-14 rounded-xl border border-gray-200 object-cover" alt="thumb">`
        : `<div class="h-10 w-14 rounded-xl border border-gray-200 ph"></div>`;

      const cardThumb = (item.image && typeof item.image === 'string' && item.image.startsWith('/static/uploads/'))
        ? `<img src="${item.image}" class="h-28 w-full object-cover border-b border-gray-200" alt="thumb">`
        : `<div class="h-28 ph border-b border-gray-200"></div>`;

      tbody.insertAdjacentHTML('beforeend', `
        <tr class="hover:bg-slate-50">
          <td class="px-5 py-4">
            <div class="flex items-center gap-3">
              ${thumb}
              <div>
                <div class="font-semibold">${escapeHtml(item.name)}</div>
                <div class="text-xs text-slate-500">ID: ${escapeHtml(String(item.id).slice(0,8))}…</div>
              </div>
            </div>
          </td>
          <td class="px-5 py-4 font-semibold">${formatRub(item.price)}</td>
          <td class="px-5 py-4">${statusBadge(item.status)}</td>
          <td class="px-5 py-4 text-slate-700">${escapeHtml(params)}</td>
          <td class="px-5 py-4 text-right">
            <div class="inline-flex gap-2">
              <button class="h-10 rounded-xl border border-gray-200 px-3 text-sm font-semibold hover:bg-white" onclick="editItem('${item.id}')">Изменить</button>
              <button class="h-10 rounded-xl border border-gray-200 px-3 text-sm font-semibold hover:bg-white" onclick="removeItem('${item.id}')">Удалить</button>
            </div>
          </td>
        </tr>
      `);

      cards.insertAdjacentHTML('beforeend', `
        <article class="rounded-3xl border border-gray-200 bg-white shadow-soft overflow-hidden">
          ${cardThumb}
          <div class="p-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-display font-extrabold">${escapeHtml(item.name)}</div>
                <div class="text-sm text-slate-600 mt-1">${escapeHtml(params)}</div>
              </div>
              <div class="text-right">
                <div class="text-sm font-semibold">${formatRub(item.price)}</div>
                <div class="mt-2">${statusBadge(item.status)}</div>
              </div>
            </div>
            <div class="mt-4 flex gap-2">
              <button class="flex-1 h-11 rounded-xl border border-gray-200 font-semibold hover:bg-slate-50" onclick="editItem('${item.id}')">Изменить</button>
              <button class="flex-1 h-11 rounded-xl border border-gray-200 font-semibold hover:bg-slate-50" onclick="removeItem('${item.id}')">Удалить</button>
            </div>
          </div>
        </article>
      `);
    });
  }

  // ---- Modal ----
  const modal = document.getElementById('modal');
  const fImageFile = document.getElementById('fImageFile');
  const imgPreview = document.getElementById('imgPreview');
  const imgPath = document.getElementById('imgPath');

  fImageFile?.addEventListener('change', () => {
    const file = fImageFile.files?.[0];
    if (!file) {
      imgPreview.innerHTML = 'preview';
      return;
    }
    const url = URL.createObjectURL(file);
    imgPreview.innerHTML = `<img src="${url}" class="w-full h-full object-cover" alt="preview">`;
  });

  function toggleTypeFields(type) {
    const hf = document.getElementById('houseFields');
    const gf = document.getElementById('gazeboFields');
    if (type === 'houses') {
      hf.classList.remove('hidden');
      gf.classList.add('hidden');
    } else {
      hf.classList.add('hidden');
      gf.classList.remove('hidden');
    }
  }

  function openModal(type) {
    document.getElementById('editId').value = '';
    document.getElementById('editType').value = type;

    document.getElementById('modalTitle').textContent = type === 'houses' ? 'Добавить домик' : 'Добавить беседку';
    document.getElementById('modalSub').textContent = 'Заполните поля и сохраните.';
    document.getElementById('formMsg').textContent = '';

    document.getElementById('fName').value = '';
    document.getElementById('fPrice').value = 0;
    document.getElementById('fStatus').value = 'active';
    fImageFile.value = '';
    imgPreview.innerHTML = 'preview';
    imgPath.textContent = '—';

    toggleTypeFields(type);

    document.getElementById('fBeds').value = 4;
    document.getElementById('fWC').checked = true;
    document.getElementById('fKitchen').checked = true;

    document.getElementById('fGazType').value = 'small';
    document.getElementById('fCapacity').value = 10;

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => document.getElementById('fName').focus(), 0);
  }

  function closeModal() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
  }

  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

  function editItem(id) {
    const item = items.find(x => x.id === id);
    if (!item) return;

    document.getElementById('editId').value = item.id;
    document.getElementById('editType').value = activeTab;

    document.getElementById('modalTitle').textContent = activeTab === 'houses' ? 'Редактировать домик' : 'Редактировать беседку';
    document.getElementById('modalSub').textContent = 'Измените поля и сохраните.';
    document.getElementById('formMsg').textContent = '';

    document.getElementById('fName').value = item.name || '';
    document.getElementById('fPrice').value = item.price || 0;
    document.getElementById('fStatus').value = item.status || 'active';
    fImageFile.value = '';
    imgPath.textContent = item.image ? item.image : '—';
    if (item.image && typeof item.image === 'string' && item.image.startsWith('/static/uploads/')) {
      imgPreview.innerHTML = `<img src="${item.image}" class="w-full h-full object-cover" alt="current">`;
    } else {
      imgPreview.innerHTML = 'preview';
    }

    toggleTypeFields(activeTab);

    if (activeTab === 'houses') {
      document.getElementById('fBeds').value = item.beds ?? 4;
      document.getElementById('fWC').checked = !!item.wc;
      document.getElementById('fKitchen').checked = !!item.kitchen;
    } else {
      document.getElementById('fGazType').value = item.gazType ?? 'small';
      document.getElementById('fCapacity').value = item.capacity ?? 10;
    }

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    setTimeout(() => document.getElementById('fName').focus(), 0);
  }

  async function saveItem() {
    const type = document.getElementById('editType').value;
    const id = document.getElementById('editId').value;

    const payload = {
      type,
      name: document.getElementById('fName').value.trim(),
      price: Number(document.getElementById('fPrice').value || 0),
      status: document.getElementById('fStatus').value
    };

    if (!payload.name) {
      document.getElementById('formMsg').textContent = 'Название обязательно.';
      return;
    }

    if (type === 'houses') {
      payload.beds = Number(document.getElementById('fBeds').value || 1);
      payload.wc = document.getElementById('fWC').checked;
      payload.kitchen = document.getElementById('fKitchen').checked;
    } else {
      payload.gazType = document.getElementById('fGazType').value;
      payload.capacity = Number(document.getElementById('fCapacity').value || 1);
    }

    const url = id ? `/api/admin/items/${id}` : `/api/admin/items`;
    const method = id ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text();
      document.getElementById('formMsg').textContent = 'Ошибка сохранения: ' + text;
      return;
    }

    const data = await res.json();
    const savedId = data?.item?.id;

    // If chosen file: upload after save (server renames file to <ID>.<ext>)
    const file = fImageFile.files?.[0];
    if (file && savedId) {
      const fd = new FormData();
      fd.append('type', type);
      fd.append('image', file);

      const up = await fetch(`/api/admin/items/${savedId}/image`, {
        method: 'POST',
        credentials: 'same-origin',
        body: fd
      });

      if (!up.ok) {
        const t = await up.text();
        document.getElementById('formMsg').textContent = 'Запись сохранена, но изображение не загрузилось: ' + t;
        await fetchItems();
        return;
      }
    }

    closeModal();
    await fetchItems();
  }

  async function removeItem(id) {
    if (!confirm('Удалить запись?')) return;

    const res = await fetch(`/api/admin/items/${id}?type=${activeTab}`, {
      method: 'DELETE',
      credentials: 'same-origin'
    });

    if (!res.ok) {
      alert('Ошибка удаления');
      return;
    }
    await fetchItems();
  }

  // init
  setTab('houses');
</script>
{% endblock %}
